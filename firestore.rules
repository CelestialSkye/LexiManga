rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions for validation
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwnDocument(userId) {
      return request.auth.uid == userId;
    }
    
    function isValidString(field, minLength, maxLength) {
      return field is string && field.size() >= minLength && field.size() <= maxLength;
    }
    
    function isValidEmail(email) {
      return isValidString(email, 5, 254) && email.matches('.*@.*\\..*');
    }
    
    function isValidTimestamp(field) {
      return field is timestamp;
    }
    
    function validateUserData(data) {
      return (
        // Required fields validation
        data.keys().hasAll(['email', 'nickname', 'createdAt']) &&
        // Email validation
        isValidEmail(data.email) &&
        // Nickname validation: 1-50 characters
        isValidString(data.nickname, 1, 50) &&
        // Timestamp validation
        isValidTimestamp(data.createdAt) &&
        // Optional fields size validation
        (!'avatarUrl' in data || isValidString(data.avatarUrl, 1, 2048)) &&
        (!'bannerUrl' in data || isValidString(data.bannerUrl, 1, 2048)) &&
        (!'nativeLang' in data || isValidString(data.nativeLang, 2, 2)) &&
        (!'targetLang' in data || isValidString(data.targetLang, 2, 2))
      );
    }
    
    function validateFavorite(data) {
      return (
        data.keys().hasAll(['mangaId', 'createdAt']) &&
        isValidString(data.mangaId, 1, 50) &&
        isValidTimestamp(data.createdAt) &&
        (!'notes' in data || isValidString(data.notes, 0, 500))
      );
    }
    
    function validateActivity(data) {
      return (
        data.keys().hasAll(['date', 'count', 'createdAt']) &&
        data.date is timestamp &&
        data.count is int &&
        data.count >= 0 &&
        data.count <= 10000 &&
        isValidTimestamp(data.createdAt)
      );
    }
    
    // User document rules
    match /users/{userId} {
      allow read: if isAuthenticated() && isOwnDocument(userId);
      allow create: if isAuthenticated() && isOwnDocument(userId) && 
                       validateUserData(request.resource.data) &&
                       request.resource.data.email == request.auth.token.email;
      allow update: if isAuthenticated() && isOwnDocument(userId) &&
                       validateUserData(request.resource.data);
      allow delete: if isAuthenticated() && isOwnDocument(userId);
      
      // Allow authenticated users to read/write their own subcollections
      match /{document=**} {
        allow read, write: if isAuthenticated() && isOwnDocument(userId);
      }
    }
    
    // Public manga collection (read-only for all authenticated users)
    match /manga/{document=**} {
      allow read: if isAuthenticated();
      allow write: if false;
    }
    
    // Favorites with validation
    match /favorites/{userId} {
      allow read: if isAuthenticated() && isOwnDocument(userId);
      allow create: if isAuthenticated() && isOwnDocument(userId) && 
                       validateFavorite(request.resource.data);
      allow update: if isAuthenticated() && isOwnDocument(userId) && 
                       validateFavorite(request.resource.data);
      allow delete: if isAuthenticated() && isOwnDocument(userId);
      
      // Favorite subcollections
      match /{document=**} {
        allow read: if isAuthenticated() && isOwnDocument(userId);
        allow create: if isAuthenticated() && isOwnDocument(userId) && 
                         validateFavorite(request.resource.data);
        allow update: if isAuthenticated() && isOwnDocument(userId) && 
                         validateFavorite(request.resource.data);
        allow delete: if isAuthenticated() && isOwnDocument(userId);
      }
    }
    
    // Daily activities with validation
    match /dailyActivities/{userId} {
      allow read: if isAuthenticated() && isOwnDocument(userId);
      allow create: if isAuthenticated() && isOwnDocument(userId) && 
                       validateActivity(request.resource.data);
      allow update: if isAuthenticated() && isOwnDocument(userId) && 
                       validateActivity(request.resource.data);
      allow delete: if isAuthenticated() && isOwnDocument(userId);
      
      // Activity subcollections
      match /{document=**} {
        allow read: if isAuthenticated() && isOwnDocument(userId);
        allow create: if isAuthenticated() && isOwnDocument(userId) && 
                         validateActivity(request.resource.data);
        allow update: if isAuthenticated() && isOwnDocument(userId) && 
                         validateActivity(request.resource.data);
        allow delete: if isAuthenticated() && isOwnDocument(userId);
      }
    }
    
    // Rate limits collection (server-only writes)
    match /rateLimits/{document=**} {
      allow read, write: if false; // Only accessible via backend via service account
    }
    
    // Deny everything else by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}